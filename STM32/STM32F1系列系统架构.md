## STM32F1系列系统架构

作者：MRZHENG

### 概念补充

#### RAM和ROM的区别

---



- RAM：读写速度快、掉电数据丢失；类比于电脑内存的作用。
- ROM：读写速度相对慢、掉电数据仍在；类比于电脑硬盘的作用

 

**RAM =  Random access Memory（随机存储存储器）**

掉电丢失，相当于电脑内存，其在Stm32 中使用的是SRAM，相当于内存，可以开辟栈和堆，以及程序运行时使用的临时变量



**ROM = Read-Only Memory (只读存储存储器)**

掉电不丢失，相当于电脑硬盘，其在Stm32中使用的是FLASH，用于存储代码中的 常量 和 代码



---

#### STM32内部架构图

![image-20250924101839590](https://mrzhb.oss-cn-chengdu.aliyuncs.com/image-20250924101839590.png)

---



#### 驱动单元（数据请求的发起者）

功能：发起读写操作，指挥数据传输，通过读写被动单元，比如读写寄存器，去控制单片机与外界交互

- #####  ICode总线

  ICode中的 I 表示 Instruction，即指令。我们写好的程序经过编译之后都是一条条指令，存放在FLASH中，内核要读取这些指令来执行程序就必须通过ICode总线，它几乎每时每刻都需要被使用，它是专门用来取指的。

- ##### DCode总线

  Dcode 中的D 表示data，那说明这条总线是用来取数的。我们在写程序的时候，**数据有常量和变量两种， 常量就是固定不变的，用C语言中的const关键字修饰，是放到内部的FLASH当中的，变量是可变的，不管是全局变量还是局部变量都放在内部的SRAM**。 因为数据可以被Dcode总线和DMA总线访问，所以为了避免访问冲突，在取数的时候需要经过一个**总线矩阵来仲裁，决定哪个总线在取数**。

- ##### 系统总线

  主要用于访问外设寄存器，对于外设寄存器的读写由这条总线来完成

- ##### DMA总线

  用于传输数据，这个总线性能很强大，可以传输外设的寄存器，也可以是 SRAM 去传输变量，也可以传输内部的FLASH

  由于DMA和Dcode 都是取数的主动单元，所以需要经过仲裁来决定谁先去取数据

---



#### 被动单元 (数据请求的响应者)

功能：存储数据

- **FLASH**

  用于存储程序以及常量，FLASH 属于之前提到的Read-only-Memory（ROM），CPU提取代码去执行指令的时候，需要去通过 **ICODE总线** 去获取指令

  

- **FSMC（Flexiable static Memory Controller）**

  意思为灵活的静态的存储器控制器（所以见词知意，他并不能控制动态的存储器），通过FSMC ，去扩展内存，外部的SRAM，NAND-FLASH 和 NOR-FLASH，**不能够扩展动态的内存，例如SDRAM **

  SRAM 这个静态的意思是只要上电就行

  SDRAM 这个属于动态随机访问存储器，不仅需要供电，而且还需要定时刷新，所以就是**动态**

  

- **AHB (Advanced High-performance Bus)**

  中文名称：高级高性能总线，性能更高，支持突发传输，流水线操作，多主设备，总的来说 AHB 是芯片内部的高速公路，负责连接需要高速数据交换的设备，如 DMA ，CPU

  

- **APB(Advanced Peripheral Bus)**

  中文名称：高级外设总线。

  APB1 是低速外设总线，挂载一些对速度要求不高的设备

  APB2 是高速外设总线，挂载对速度要求高的设备

  

- **AHB到APB的桥**

  AHB(Advanced High Performance Bus)总线有一套比较复杂的通讯协议，功耗高;  而APB（Advanced Peripheral Bus) 总线 的通讯协议比较简单，功耗低。**桥的作用就是一个协议转换器和交通调度器**,

  从 AHB 总线上延申出来的 两条 APB1 和 APB2 总线，上面挂载了 STM32各种各样的外设，这个 “桥” 的概念就是上图中，AHB与APB 之间的桥接1 和桥接2

  

- **RCC （Reset and clock Control）**

  中文：复位和时钟控制器

  1.复位：控制整个芯片和部分模块的复位信号

  2.时钟： **产生并分配时钟信号**

  配置 RCC寄存器，就可以去配置各个外设时钟

  

- **SDIO(Secure Digital Input /Output)**

​        中文：安全数字输入输出接口

​        用于驱动SD卡和遵循这个SDIO标准的设备

---



#### 存储器映射

所有被控单元(可以被访问的寄存器)全部被放置在一个 4GB的地址空间，这个4GB 分为8个block, 每个Block大小为512MB，每个block 中的内容并没有全部使用

![image-20250924191516452](https://mrzhb.oss-cn-chengdu.aliyuncs.com/image-20250924191516452.png)



![image-20250924191639365](https://mrzhb.oss-cn-chengdu.aliyuncs.com/image-20250924191639365.png)

其中最重要的Block，也是我们最关心的三个块

- Block0 ： 被设计为内部FLASH
- Block1  :   被用做内部 SRAM
- Block2  :    被用于存储片上外设

接下来我们分别介绍这三个块的划分

---

##### BLOCK0内部区域

| 块     | 用途说明                                                     | 地址范围                          |
| ------ | ------------------------------------------------------------ | --------------------------------- |
| Block0 | 预留                                                         | 0x1FFE C008 ~ 0x1FFF FFFF         |
|        | 选项字节：用于配置读写保护、 BOR 级别、软件/硬件看门狗以及器件处于待机或停止模式下的复位。当芯片不小心被锁住之后，我们可以从RAM里面启动来修改这部分相应的寄存器位。 | 0x1FFF F800 - 0x1FFF F80F         |
|        | 系统存储器：里面存的是ST出厂时烧写好的isp自举程序（即Bootloader），用户无法改动。串口下载的时候需要用到这部分程序。 | 0x1FFF F000- 0x1FFF F7FF          |
|        | 预留                                                         | 0x0808 0000 ~ 0x1FFF EFFF         |
|        | FLASH：我们的程序就放在这里。                                | 0x0800 0000 ~ 0x0807 FFFF (512KB) |
|        | 预留                                                         | 0x0008 0000 ~ 0x07FF FFFF         |
|        | 取决于BOOT引脚，为FLASH、系统存储器、SRAM的别名。            | 0x0000 0000 ~ 0x0007 FFFF         |

##### BLOCK1内部区域

| 块     | 用途说明  | 地址范围                  |
| ------ | --------- | ------------------------- |
| Block1 | 预留      | 0x2001 0000 ~ 0x3FFF FFFF |
|        | SRAM 64KB | 0x2000 0000 ~0x2000 FFFF  |

##### BLOCK2内部区域

| 块     | 用途说明      | 地址范围                  |
| ------ | ------------- | ------------------------- |
| Block2 | APB1 总线外设 | 0x4000 0000 ~ 0x4000 77FF |
|        | APB2 总线外设 | 0x4001 0000 ~ 0x4001 3FFF |
|        | AHB 总线外设  | 0x4001 8000 ~ 0x5003 FFFF |

这里存储的是各个外设的寄存器，我们平时书写程序，最底层就是说控制这些寄存器去对单片机做一个基本的控制，达到与单片机与外界交互的功能
